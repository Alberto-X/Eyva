<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ux_data_broker_transform">
    <sys_ux_data_broker_transform action="INSERT_OR_UPDATE">
        <acl_failure_result/>
        <api_name>x_802331_eyva.Add worker to shift</api_name>
        <description>Given a worker and a target shift, add the worker to the shift</description>
        <mutates_server_data>true</mutates_server_data>
        <name>Add worker to shift</name>
        <output_schema>{&#13;
  "name": "response",&#13;
  "label": "Response",&#13;
  "description": "The response from the server",&#13;
  "fieldType": "object",&#13;
  "properties": {&#13;
    "messages": {&#13;
      "fieldType": "array",&#13;
      "items": {&#13;
        "fieldType": "string",&#13;
        "description": "A message from the server"&#13;
      }&#13;
    }&#13;
  }&#13;
}</output_schema>
        <private>false</private>
        <props>[&#13;
  {&#13;
    "name": "worker",&#13;
    "label": "Worker",&#13;
    "description": "The worker to add",&#13;
    "readOnly": "false",&#13;
    "fieldType": "reference",&#13;
    "mandatory": "true",&#13;
    "defaultValue": {},&#13;
    "typeMetadata": {"reference": "x_802331_eyva_worker"}&#13;
  },&#13;
  {&#13;
    "name": "shift",&#13;
    "label": "Shift",&#13;
    "description": "The shift that the user should be added to",&#13;
    "readOnly": "false",&#13;
    "fieldType": "reference",&#13;
    "mandatory": "true",&#13;
    "defaultValue": "",&#13;
    "typeMetadata": {"reference": "x_802331_eyva_shift"}&#13;
  }&#13;
]</props>
        <required_translations>[ {
  "message" : "Shift",
  "comment" : ""
}, {
  "message" : "The shift that the user should be added to",
  "comment" : ""
}, {
  "message" : "The worker to add",
  "comment" : ""
}, {
  "message" : "Worker",
  "comment" : ""
} ]</required_translations>
        <schema_version>1.0.0</schema_version>
        <script><![CDATA[function transform(input) {
	var messages = [];
	var wkr = input.worker;
	var shift = input.shift;
	var userSysId;
	var workerSysId;
	var shiftWorkerSysId;

	if (wkr.id == 'new-worker') {
		// Create user and worker (from dropdown item)
		var firstName = wkr.label.split(' ', 1)[0].trim();
		var lastName = wkr.label.slice(firstName.length + 1).trim();
		var userName = firstName.toLowerCase() + '.' + lastName.toLowerCase();

		var userGr = new GlideRecord('sys_user');
		userGr.initialize();
		userGr.setValue('first_name', firstName);
		userGr.setValue('last_name', lastName);
		userGr.setValue('user_name', userName);
		userSysId = userGr.insert();
		
		if (userSysId) {
			var workerGr = new GlideRecord('x_802331_eyva_worker');
			workerGr.initialize();
			workerGr.setValue('user', userSysId);
			workerGr.setValue('adult', wkr.adult);
			workerSysId = workerGr.insert();
			messages.push((workerSysId ? 'Created user & worker for ' : 'Failed to create worker for ') + wkr.label);
		} else {
			messages.push('Failed to create user for ' + wkr.label);
		}
	}
	if (workerSysId || wkr.id) {
		// Add worker to shift (shift is formatted like dropdown item)
		messages.push('shift');
		messages.push(shift);
		var shiftWorkerGr = new GlideRecord('x_802331_eyva_shift_worker');
		shiftWorkerGr.initialize();
		shiftWorkerGr.setValue('worker', workerSysId || wkr.id);
		shiftWorkerGr.setValue('shift', shift.id);
		shiftWorkerGr.setValue('arriving_at', '05:00:00');
		shiftWorkerGr.setValue('leaving_at', '05:00:00');
		shiftWorkerSysId = shiftWorkerGr.insert();
		messages.push((shiftWorkerSysId ? 'Added ' : 'Failed to add ') + wkr.label + ' to shift ' + shift.label);
	} else {
		messages.push('Failed to find worker, so could not add ' + wkr.label + ' to shift ' + shift.label);
	}
	return { messages: messages };
}]]></script>
        <sys_class_name>sys_ux_data_broker_transform</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-08-07 03:31:11</sys_created_on>
        <sys_id>71e38b30476435102dabcd9bd36d4320</sys_id>
        <sys_mod_count>6</sys_mod_count>
        <sys_name>Add worker to shift</sys_name>
        <sys_package display_value="Eyva" source="x_802331_eyva">04928fc32fd41110da77c886f699b615</sys_package>
        <sys_policy/>
        <sys_scope display_value="Eyva">04928fc32fd41110da77c886f699b615</sys_scope>
        <sys_update_name>sys_ux_data_broker_transform_71e38b30476435102dabcd9bd36d4320</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2023-08-07 14:04:58</sys_updated_on>
    </sys_ux_data_broker_transform>
    <sys_translated_text action="delete_multiple" query="documentkey=71e38b30476435102dabcd9bd36d4320"/>
</record_update>
